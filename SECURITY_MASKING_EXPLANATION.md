# 監査ログの機密情報マスキングについて

## 機密情報マスキングとは？

監査ログに記録される情報の中に、**パスワード、クレジットカード番号、個人情報**などの機密情報が含まれる可能性があります。これらの情報をそのまま記録すると、以下のリスクがあります：

1. **データベースが漏洩した場合**、機密情報がそのまま流出する
2. **監査ログを閲覧する管理者**が機密情報を目にする機会が増える
3. **GDPRや個人情報保護法**などのコンプライアンス違反のリスク

**機密情報マスキング**は、これらの情報を監査ログに記録する前に、自動的に一部を隠す（マスキング）する機能です。

---

## 現在の実装状況

### ✅ 既にマスキングされている情報
- **クレジットカード番号**: `cardLast4` として最後の4桁のみ保存（安全）

### ⚠️ マスキングが必要な可能性がある情報

現在、監査ログの `details` フィールドには以下の情報が保存されています：

#### 1. ユーザー更新時の情報
```typescript
details: {
  before: {
    name: "山田太郎",
    lastName: "山田",
    firstName: "太郎",
    phone: "090-1234-5678",  // ← 電話番号（個人情報）
  },
  after: {
    // ...
  }
}
```

#### 2. 将来的に含まれる可能性がある情報
- **パスワード**（ハッシュ化されていても）
- **クレジットカード番号全体**（現在は最後4桁のみ）
- **セキュリティコード（CVV）**
- **個人識別番号**
- **住所の詳細情報**

---

## マスキングの例

### 例1: 電話番号のマスキング
```
マスキング前: "090-1234-5678"
マスキング後: "***-****-5678"  // 最後の4桁のみ表示
```

### 例2: クレジットカード番号のマスキング
```
マスキング前: "1234-5678-9012-3456"
マスキング後: "****-****-****-3456"  // 最後の4桁のみ表示
```

### 例3: パスワードのマスキング
```
マスキング前: "$2a$10$abcdefghijklmnopqrstuvwxyz..."
マスキング後: "********"  // 完全にマスキング
```

### 例4: メールアドレスのマスキング（オプション）
```
マスキング前: "user@example.com"
マスキング後: "u***@example.com"  // ローカル部分をマスキング
```

---

## 実装方法

### 方法1: `createAuditLog` 関数内でマスキング（推奨）

監査ログを作成する際に、自動的に機密情報をマスキングします。

**メリット**:
- すべての監査ログ作成箇所で自動的に適用される
- 実装漏れがない
- 一元管理できる

### 方法2: 各APIルートで個別にマスキング

各APIルートで `details` を作成する際にマスキングします。

**メリット**:
- 柔軟性が高い
- 特定の情報だけをマスキングできる

**デメリット**:
- 実装漏れのリスク
- コードの重複

---

## 推奨実装

`lib/audit-log.ts` にマスキング関数を追加し、`createAuditLog` 関数内で自動的に適用する方法が最も安全です。

### 実装の優先順位

1. **高優先度**: パスワード、クレジットカード番号全体、CVV
2. **中優先度**: 電話番号、個人識別番号
3. **低優先度**: メールアドレス、住所（必要に応じて）

---

## 注意点

1. **マスキングした情報は復元できない**
   - 元の情報が必要な場合は、別途安全に保存する必要がある

2. **マスキングのレベル**
   - 完全にマスキング（パスワード）
   - 一部のみ表示（クレジットカード、電話番号）

3. **パフォーマンス**
   - 大量のデータをマスキングする場合は、パフォーマンスへの影響を考慮

4. **ログの有用性**
   - マスキングしすぎると、監査ログの有用性が低下する可能性がある
   - バランスが重要
